# If you come from bash you might have to change your $PATH.
export PATH=$HOME/bin:$HOME/.local/bin:/usr/local/bin:$PATH

# Preferred editor for local and remote sessions
export EDITOR='nvim'
export VISUAL='cursor'

# History configuration
HISTFILE=~/.zsh_history
HISTSIZE=10000
SAVEHIST=10000
setopt HIST_IGNORE_DUPS      # Don't record duplicates
setopt HIST_IGNORE_SPACE     # Don't record commands starting with space
setopt SHARE_HISTORY         # Share history between sessions
setopt APPEND_HISTORY        # Append rather than overwrite

{{ if eq .chezmoi.os "darwin" -}}
# >>> nvm (Homebrew) >>>
# Initialize nvm for interactive shells
export NVM_DIR="$HOME/.nvm"
if command -v brew >/dev/null 2>&1; then
  BREW_PREFIX="$(brew --prefix)"
else
  if [ -d "/opt/homebrew" ]; then
    BREW_PREFIX="/opt/homebrew"
  else
    BREW_PREFIX="/usr/local"
  fi
fi
export BREW_PREFIX

# Ensure Homebrew bin is on PATH (Apple Silicon or Intel)
export PATH="$BREW_PREFIX/bin:$PATH"

if [ -s "$BREW_PREFIX/opt/nvm/nvm.sh" ]; then
  . "$BREW_PREFIX/opt/nvm/nvm.sh"
fi

# Initialize zsh completion system
autoload -Uz compinit && compinit

# Enable bash-style completions to load nvm's completion under zsh
autoload -U +X bashcompinit && bashcompinit
if [ -s "$BREW_PREFIX/opt/nvm/etc/bash_completion.d/nvm" ]; then
  . "$BREW_PREFIX/opt/nvm/etc/bash_completion.d/nvm"
fi
# <<< nvm (Homebrew) <<<
# Disable Homebrew auto-update
export HOMEBREW_NO_AUTO_UPDATE=1

# Homebrew wrapper and hook
if [ -f "$BREW_PREFIX/etc/brew-wrap" ]; then
  source "$BREW_PREFIX/etc/brew-wrap"
  _post_brewfile_update () {
    echo "Brewfile was updated!"
  }
fi

{{end -}}
# Load aliases
[ -f "$HOME/.zsh/aliases.zsh" ] && source "$HOME/.zsh/aliases.zsh"


# bun
export BUN_INSTALL="$HOME/.bun"
export PATH="$BUN_INSTALL/bin:$PATH"
# bun completions
[ -s "$BUN_INSTALL/_bun" ] && source "$BUN_INSTALL/_bun"


# enable fzf fuzzy finder and hotkeys
if command -v fzf >/dev/null 2>&1; then
  eval "$(fzf --zsh)"
fi
# -- Use fd instead of fzf --

export FZF_DEFAULT_COMMAND="fd --hidden --strip-cwd-prefix --exclude .git"
export FZF_CTRL_T_COMMAND="$FZF_DEFAULT_COMMAND"
export FZF_CTRL_T_OPTS="--preview 'bat --color=always --style=numbers --line-range=:500 {} 2>/dev/null || cat {}'"
export FZF_ALT_C_COMMAND="fd --type=d --hidden --strip-cwd-prefix --exclude .git"
export FZF_ALT_C_OPTS="--preview 'eza --tree --color=always {} | head -200'"

# Use fd (https://github.com/sharkdp/fd) for listing path candidates.
# - The first argument to the function ($1) is the base path to start traversal
# - See the source code (completion.{bash,zsh}) for the details.
_fzf_compgen_path() {
  fd --hidden --exclude .git . "$1"
}

# Use fd to generate the list for directory completion
_fzf_compgen_dir() {
  fd --type=d --hidden --exclude .git . "$1"
}

# zoxide
if command -v zoxide &> /dev/null; then
  eval "$(zoxide init zsh)"
  alias cd="zd"
  zd() {
    if [ $# -eq 0 ]; then
      builtin cd ~ && return
    elif [ -d "$1" ]; then
      builtin cd "$1"
    else
      z "$@" && printf "\U000F17A9 " && pwd || echo "Error: Directory not found"
    fi
  }
fi

# starship
command -v starship >/dev/null 2>&1 && eval "$(starship init zsh)"

# >>> AI Chat integration ZSH v0.2
_aichat_zsh() {
    if [[ -n "$BUFFER" ]]; then
        local _old=$BUFFER
        BUFFER+="⌛"
        zle -I && zle redisplay
        BUFFER=$(aichat -e "$_old")
        zle end-of-line
    fi
}
zle -N _aichat_zsh
bindkey '\ee' _aichat_zsh
# <<< AI Chat integration ZSH v0.2
# Lazy load thefuck (avoids ~300ms startup penalty)
if command -v thefuck >/dev/null 2>&1; then
  fuck() {
    unfunction fuck
    eval "$(thefuck --alias)"
    fuck "$@"
  }
fi

# go
export GOPATH="${GOPATH:-$HOME/go}"
export PATH="$GOPATH/bin:$PATH"

# Secondary prompt for multi-line commands
PROMPT2='%F{8}∙%f '

{{ if eq .chezmoi.os "darwin" -}}
# Activate autosuggestions (must be before syntax highlighting)
if [ -s "$BREW_PREFIX/share/zsh-autosuggestions/zsh-autosuggestions.zsh" ]; then
  source "$BREW_PREFIX/share/zsh-autosuggestions/zsh-autosuggestions.zsh"
fi

# Activate syntax highlighting (should be last)
if [ -s "$BREW_PREFIX/share/zsh-syntax-highlighting/zsh-syntax-highlighting.zsh" ]; then
  source "$BREW_PREFIX/share/zsh-syntax-highlighting/zsh-syntax-highlighting.zsh"
  # Disable underline
  (( ${+ZSH_HIGHLIGHT_STYLES} )) || typeset -gA ZSH_HIGHLIGHT_STYLES
  ZSH_HIGHLIGHT_STYLES[path]=none
  ZSH_HIGHLIGHT_STYLES[path_prefix]=none
  ZSH_HIGHLIGHT_STYLES[path_approx]=none
  ZSH_HIGHLIGHT_STYLES[path_pathseparator]=none
  ZSH_HIGHLIGHT_STYLES[path_prefix_pathseparator]=none
fi
{{ else if eq .chezmoi.os "linux" -}}
# Activate autosuggestions (must be before syntax highlighting)
if [ -s "/usr/share/zsh-autosuggestions/zsh-autosuggestions.zsh" ]; then
  source "/usr/share/zsh-autosuggestions/zsh-autosuggestions.zsh"
fi

# Activate syntax highlighting (should be last)
if [ -s "/usr/share/zsh-syntax-highlighting/zsh-syntax-highlighting.zsh" ]; then
  source "/usr/share/zsh-syntax-highlighting/zsh-syntax-highlighting.zsh"
  # Disable underline
  (( ${+ZSH_HIGHLIGHT_STYLES} )) || typeset -gA ZSH_HIGHLIGHT_STYLES
  ZSH_HIGHLIGHT_STYLES[path]=none
  ZSH_HIGHLIGHT_STYLES[path_prefix]=none
  ZSH_HIGHLIGHT_STYLES[path_approx]=none
  ZSH_HIGHLIGHT_STYLES[path_pathseparator]=none
  ZSH_HIGHLIGHT_STYLES[path_prefix_pathseparator]=none
fi
{{end -}}



{{ if eq .chezmoi.os "linux" -}}
# Add neovim to the PATH only in Linux
export PATH="$PATH:/opt/nvim-linux-x86_64/bin"
{{ end -}}

{{ if eq .chezmoi.os "linux" -}}
export NVM_DIR="$HOME/.config/nvm"
[ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"  # This loads nvm
[ -s "$NVM_DIR/bash_completion" ] && \. "$NVM_DIR/bash_completion"  # This loads nvm bash_completion
{{ end -}}

# Add llm cmdcomp shell shortcut
command -v llm >/dev/null 2>&1 && eval "$(llm cmdcomp --init zsh)"

# Set the LiteLLM URL for llm CLI plugin
export LITELLM_URL={{ onepasswordRead "op://Dev/LiteLLM/website" }}